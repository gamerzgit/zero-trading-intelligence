services:
  # TimescaleDB (PostgreSQL with TimescaleDB extension)
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: zero-timescaledb
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-zero_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-zero_trading}
    volumes:
      - ./data_nvme/timescaledb:/var/lib/postgresql/data
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-zero_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - zero-network

  # Redis (Hot state, Pub/Sub)
  redis:
    image: redis:7-alpine
    container_name: zero-redis
    command: redis-server --appendonly yes
    volumes:
      - ./data_nvme/redis:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - zero-network

  # Grafana (Visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: zero-grafana
    user: "0:0"  # Run as root to avoid permission issues
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_INSTALL_PLUGINS: ""
      GF_PATHS_PROVISIONING: /etc/grafana/provisioning
    volumes:
      - ./data_nvme/grafana:/var/lib/grafana
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    depends_on:
      - timescaledb
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - zero-network

  # Price Ingestion Service (Milestone 1)
  zero-ingest-price:
    build:
      context: ..
      dockerfile: services/ingest/Dockerfile
    container_name: zero-ingest-price
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Provider
      PROVIDER_TYPE: ${PROVIDER_TYPE:-mock}
      POLYGON_API_KEY: ${POLYGON_API_KEY:-}
      ALPACA_API_KEY: ${ALPACA_API_KEY:-}
      ALPACA_SECRET_KEY: ${ALPACA_SECRET_KEY:-}
      ALPACA_PAPER: ${ALPACA_PAPER:-true}
      # API
      API_PORT: ${API_PORT:-8080}
    ports:
      - "${API_PORT:-8080}:8080"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - zero-network

  # Regime Engine Service (Milestone 2)
  zero-regime:
    build:
      context: ..
      dockerfile: services/regime/Dockerfile
    container_name: zero-regime
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Alpaca (for VIX proxy)
      ALPACA_API_KEY: ${ALPACA_API_KEY:-}
      ALPACA_SECRET_KEY: ${ALPACA_SECRET_KEY:-}
      # API
      REGIME_API_PORT: ${REGIME_API_PORT:-8000}
    ports:
      - "${REGIME_API_PORT:-8000}:8000"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - zero-network

  # Scanner Service (Milestone 3)
  zero-scanner:
    build:
      context: ..
      dockerfile: services/scanner/Dockerfile
    container_name: zero-scanner
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Alpaca (for universe fetching)
      ALPACA_API_KEY: ${ALPACA_API_KEY:-}
      ALPACA_SECRET_KEY: ${ALPACA_SECRET_KEY:-}
      # Scanner config
      SCAN_INTERVAL_SECONDS: ${SCAN_INTERVAL_SECONDS:-60}
      # API
      API_PORT: ${SCANNER_API_PORT:-8001}
    ports:
      - "${SCANNER_API_PORT:-8001}:8001"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      zero-regime:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - zero-network

  # Core Logic Service (Milestone 4)
  zero-core-logic:
    build:
      context: ..
      dockerfile: services/core/Dockerfile
    container_name: zero-core-logic
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # API
      CORE_API_PORT: ${CORE_API_PORT:-8002}
    ports:
      - "${CORE_API_PORT:-8002}:8002"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      zero-regime:
        condition: service_started
      zero-scanner:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - zero-network

  # Dashboard Service (Milestone 5)
  zero-dashboard:
    build:
      context: ..
      dockerfile: services/dashboard/Dockerfile
    container_name: zero-dashboard
    environment:
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
    ports:
      - "${DASHBOARD_PORT:-8501}:8501"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8501/_stcore/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - zero-network

  # Execution Gateway Service (Milestone 6 - Paper Only, Opt-In)
  zero-execution:
    build:
      context: ..
      dockerfile: services/execution/Dockerfile
    container_name: zero-execution
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Alpaca (PAPER ONLY - Hard Enforced)
      ALPACA_API_KEY: ${ALPACA_API_KEY:-}
      ALPACA_SECRET_KEY: ${ALPACA_SECRET_KEY:-}
      ALPACA_PAPER: ${ALPACA_PAPER:-true}
      # API
      EXECUTION_API_PORT: ${EXECUTION_API_PORT:-8003}
    ports:
      - "${EXECUTION_API_PORT:-8003}:8003"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      zero-core-logic:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - zero-network

  # Truth Test Service (Milestone 7)
  zero-truth-test:
    build:
      context: ..
      dockerfile: services/truth-test/Dockerfile
    container_name: zero-truth-test
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # API
      TRUTH_TEST_API_PORT: ${TRUTH_TEST_API_PORT:-8004}
    ports:
      - "${TRUTH_TEST_API_PORT:-8004}:8004"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - zero-network

  # Attention Engine (Milestone 8)
  zero-attention:
    build:
      context: ..
      dockerfile: services/attention/Dockerfile
    container_name: zero-attention
    environment:
      # Database
      DB_HOST: ${DB_HOST:-timescaledb}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-zero_trading}
      DB_USER: ${DB_USER:-zero_user}
      DB_PASSWORD: ${DB_PASSWORD}
      # Redis
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # API
      ATTENTION_API_PORT: ${ATTENTION_API_PORT:-8005}
      ATTENTION_INTERVAL: ${ATTENTION_INTERVAL:-60}
    ports:
      - "${ATTENTION_API_PORT:-8005}:8005"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped
    networks:
      - zero-network

networks:
  zero-network:
    driver: bridge

volumes:
  timescaledb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data_nvme/timescaledb
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data_nvme/redis
  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data_nvme/grafana

